{"metadata": {"version": 1, "disable_limits": false, "instance_type": "ml.m5.4xlarge", "disable_validation": true}, "parameters": [], "nodes": [{"node_id": "e82ed2b7-58f5-4d78-82c2-290f8d905dbb", "type": "SOURCE", "operator": "sagemaker.s3_source_0.1", "parameters": {"dataset_definition": {"datasetSourceType": "Local File Upload", "name": "storedata_total.csv", "description": null, "s3ExecutionContext": {"s3Uri": "s3://sagemaker-us-east-1-654658033055/Canvas/default-20251101T133010/uploads/storedata_total.csv", "s3ContentType": "csv", "s3HasHeader": true, "s3FieldDelimiter": ",", "s3DirIncludesNested": false, "s3AddsFilenameColumn": false, "s3RoleArn": null, "s3CsvEncodingType": "UTF_8", "s3SkipLines": 0, "s3MultiLine": false, "s3DataType": "S3Prefix", "s3ManifestPlain": {"s3Uris": null}}, "canvasDatasetMetadata": null}}, "inputs": [], "outputs": [{"name": "default", "sampling": {"sampling_method": "sample_by_count", "sample_size": 50000}}]}, {"node_id": "cf0350c3-6b46-4393-b9ce-fa410ac8b5a2", "type": "TRANSFORM", "operator": "sagemaker.spark.infer_and_cast_type_0.1", "parameters": {}, "trained_parameters": {"schema": {"custid": "string", "retained": "long", "created": "datetime", "firstorder": "datetime", "lastorder": "datetime", "esent": "long", "eopenrate": "float", "eclickrate": "float", "avgorder": "float", "ordfreq": "float", "paperless": "long", "refill": "long", "doorstep": "long", "favday": "string", "city": "string"}}, "inputs": [{"name": "default", "node_id": "e82ed2b7-58f5-4d78-82c2-290f8d905dbb", "output_name": "default"}], "outputs": [{"name": "default"}]}, {"node_id": "32880017-87b5-480a-98ca-ad68ac7e95e9", "type": "VISUALIZATION", "operator": "sagemaker.visualizations.data_insights_report_0.1", "parameters": {"name": "11-1-2025_10:53:31_PM", "insights_report_parameters": {}, "full_data": "false"}, "inputs": [{"name": "df", "node_id": "cf0350c3-6b46-4393-b9ce-fa410ac8b5a2", "output_name": "default"}], "outputs": [{"name": "default"}]}, {"node_id": "52554a76-66cc-4507-8ee0-a123952f1874", "type": "TRANSFORM", "operator": "sagemaker.spark.custom_code_0.1", "parameters": {"operator": "Python (Pandas)", "pandas_parameters": {"code": "import pandas as pd\nimport numpy as np\n\n# Data Wrangler calls this function. `df` is a pandas DataFrame of the current step.\ndef transform(df: pd.DataFrame) -> pd.DataFrame:\n    # --- Ensure date types ---\n    for col in [\"created\", \"firstorder\", \"lastorder\"]:\n        if col in df.columns:\n            df[col] = pd.to_datetime(df[col], errors=\"coerce\")\n\n    # Helper: days between (safe)\n    def days_between(later, earlier):\n        delta = (later - earlier).dt.total_seconds() / (24 * 3600)\n        return pd.to_numeric(delta, errors=\"coerce\")\n\n    # 1) customer_age_days = today - created\n    today = pd.Timestamp.utcnow().normalize()\n    df[\"customer_age_days\"] = days_between(pd.Series(today, index=df.index), df[\"created\"])\n\n    # 2) tenure_days = lastorder - firstorder\n    if \"lastorder\" in df.columns and \"firstorder\" in df.columns:\n        df[\"tenure_days\"] = days_between(df[\"lastorder\"], df[\"firstorder\"])\n\n    # 3) avg_click_rate = eclickrate / eopenrate (safe)\n    if \"eclickrate\" in df.columns and \"eopenrate\" in df.columns:\n        den = df[\"eopenrate\"].replace(0, np.nan)\n        df[\"avg_click_rate\"] = df[\"eclickrate\"] / den\n\n    # 4) is_loyal_customer = (ordfreq > 0.10)\n    if \"ordfreq\" in df.columns:\n        df[\"is_loyal_customer\"] = (df[\"ordfreq\"] > 0.10).astype(int)\n\n    # 5) email_engagement = (eopenrate + eclickrate) / 2\n    if \"eopenrate\" in df.columns and \"eclickrate\" in df.columns:\n        df[\"email_engagement\"] = (df[\"eopenrate\"] + df[\"eclickrate\"]) / 2.0\n\n    # 6) high_spender_flag = (avgorder > 100)\n    if \"avgorder\" in df.columns:\n        df[\"high_spender_flag\"] = (df[\"avgorder\"] > 100).astype(int)\n\n    # 7) order_per_day = ordfreq / tenure_days (safe)\n    if \"ordfreq\" in df.columns and \"tenure_days\" in df.columns:\n        tenure_safe = df[\"tenure_days\"].where(df[\"tenure_days\"] > 0, np.nan)\n        df[\"order_per_day\"] = df[\"ordfreq\"] / tenure_safe\n\n    # 8) is_paperless_user = (paperless == 1)\n    if \"paperless\" in df.columns:\n        df[\"is_paperless_user\"] = (df[\"paperless\"] == 1).astype(int)\n\n    # 9) One-hot encode favday and city (optional; use built-ins if you prefer)\n    if \"favday\" in df.columns:\n        fav_dummies = pd.get_dummies(df[\"favday\"], prefix=\"favday\", dummy_na=True)\n        df = pd.concat([df.drop(columns=[\"favday\"]), fav_dummies], axis=1)\n\n    if \"city\" in df.columns:\n        city_dummies = pd.get_dummies(df[\"city\"], prefix=\"city\", dummy_na=True)\n        df = pd.concat([df.drop(columns=[\"city\"]), city_dummies], axis=1)\n\n    # Clean infinities\n    df.replace([np.inf, -np.inf], np.nan, inplace=True)\n\n    return df\n\n"}, "pyspark_parameters": {}, "name": "engineering-new-features-for-store"}, "inputs": [{"name": "df", "node_id": "cf0350c3-6b46-4393-b9ce-fa410ac8b5a2", "output_name": "default"}], "outputs": [{"name": "default"}]}, {"node_id": "e41352e0-374f-4423-9cf2-089c9c8278d0", "type": "VISUALIZATION", "operator": "sagemaker.visualizations.data_insights_report_0.1", "parameters": {"name": "11-1-2025_11:30:24_PM", "insights_report_parameters": {}, "full_data": "false"}, "inputs": [{"name": "df", "node_id": "52554a76-66cc-4507-8ee0-a123952f1874", "output_name": "default"}], "outputs": [{"name": "default"}]}, {"node_id": "6389133f-44e6-439e-91a1-61e195f2b93f", "type": "TRANSFORM", "operator": "sagemaker.spark.handle_missing_0.1", "parameters": {"operator": "Drop missing", "drop_missing_parameters": {"input_column": ["created", "firstorder", "lastorder", "custid"]}, "impute_parameters": {"column_type": "Numeric", "numeric_parameters": {"strategy": "Approximate Median"}}}, "inputs": [{"name": "df", "node_id": "52554a76-66cc-4507-8ee0-a123952f1874", "output_name": "default"}], "outputs": [{"name": "default"}]}, {"node_id": "6cf878a5-c3ef-4ffb-a98e-9c05a88a9a20", "type": "TRANSFORM", "operator": "sagemaker.spark.custom_code_0.1", "parameters": {"operator": "Python (PySpark)", "pyspark_parameters": {"code": "# Table is available as variable `df`\nimport pandas as pd\nimport numpy as np\ndef transform(df: pd.DataFrame) -> pd.DataFrame:\n    # --- Cell 7: One-hot encode categoricals (Data Wrangler: Encode categorical) ---\n    # favday_encoded, city_encoded\n    cat_cols = []\n    if \"favday\" in df.columns:\n        cat_cols.append(\"favday\")\n    if \"city\" in df.columns:\n        cat_cols.append(\"city\")\n    \n    if cat_cols:\n        df = pd.get_dummies(df, columns=cat_cols, prefix=cat_cols, dummy_na=True)\n    \n    print(\"After one-hot:\", df.shape)\n    return df"}, "name": "One-hot encode categoricals "}, "inputs": [{"name": "df", "node_id": "6389133f-44e6-439e-91a1-61e195f2b93f", "output_name": "default"}], "outputs": [{"name": "default"}]}, {"node_id": "d2c26ca1-deb8-4ff4-bd4f-59195ddbe4e9", "type": "TRANSFORM", "operator": "sagemaker.spark.custom_code_0.1", "parameters": {"operator": "Python (PySpark)", "pyspark_parameters": {"code": "# Table is available as variable `df`\n\n#fill numeric NaN with 0; keep Int64 NA as-is (or fill with 0)\nimport pandas as pd\nimport numpy as np\n\ndef transform(df: pd.DataFrame) -> pd.DataFrame:\n    num_cols = df.select_dtypes(include=[\"float64\", \"float32\", \"int64\", \"int32\"]).columns\n    df[num_cols] = df[num_cols].fillna(0)\n    print(\"Post-imputation NA counts (top 10):\")\n    print(df.isna().sum().sort_values(ascending=False).head(10))\n    return df"}, "name": "Final imputation policy"}, "inputs": [{"name": "df", "node_id": "6cf878a5-c3ef-4ffb-a98e-9c05a88a9a20", "output_name": "default"}], "outputs": [{"name": "default"}]}]}